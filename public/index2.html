<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8">
  <title>Tra c·ª©u ƒë∆°n h√†ng</title>
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
  <link rel="stylesheet" href="style.css">
</head>
<body>
  <div class="container">
    <h2>üì¶ Tra c·ª©u ƒë∆°n h√†ng</h2>
    <div class="input-group">
      <input id="orderIds" placeholder="Nh·∫≠p m√£ ƒë∆°n">
      <div class="btn-group">
        <button onclick="getAddresses()">Tra c·ª©u</button>
        <button onclick="downloadExcel()">üì• Xu·∫•t d·ªØ li·ªáu</button>
      </div>
    </div>
    <div id="result"></div>
  </div>

  <script>
    let lastData = []; // l∆∞u d·ªØ li·ªáu API tr·∫£ v·ªÅ

    async function getAddresses() {
      const input = document.getElementById("orderIds").value.trim();
      const resultDiv = document.getElementById("result");

      if (!input) {
        resultDiv.innerHTML = "<p style='color:red'>‚ö†Ô∏è Nh·∫≠p m√£ ƒë∆°n!</p>";
        return;
      }

      const orderIds = input.split(/\s+/);
      resultDiv.innerHTML = "<p>‚è≥ ƒêang tra c·ª©u...</p>";

      try {
        const res = await fetch("/api/tracking", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ orderIds })
        });

        const data = await res.json();
        lastData = data; // l∆∞u l·∫°i ƒë·ªÉ export Excel

        if (Array.isArray(data)) {
          let table = `
            <table>
              <thead>
                <tr>
                  <th>M√£ ƒë∆°n</th>
                  <th>Ng∆∞·ªùi nh·∫≠n</th>
                  <th>ƒê·ªãa ch·ªâ</th>
                  <th>M√£ ƒëo·∫°n</th>
                </tr>
              </thead>
              <tbody>
          `;

          table += data.map(item => {
            if (item.error) {
              return `<tr class="error">
                        <td>${item.orderId}</td>
                        <td colspan="3">‚ùå ${item.error}</td>
                      </tr>`;
            }
            return `<tr>
                      <td>${item.orderId}</td>
                      <td>${item.receiverName || "-"}</td>
                      <td>${item.receiverAddress || "-"}</td>
                      <td>${item.terminalDispatchCode || "-"}</td>
                    </tr>`;
          }).join("");

          table += "</tbody></table>";
          resultDiv.innerHTML = table;
        } else {
          resultDiv.innerHTML = "<p style='color:red'>‚ùå Kh√¥ng t√¨m th·∫•y k·∫øt qu·∫£!</p>";
        }
      } catch (err) {
        resultDiv.innerHTML = "<p style='color:red'>‚ö†Ô∏è L·ªói khi g·ªçi API!</p>";
      }
    }

    function downloadExcel() {
      if (!lastData || lastData.length === 0) {
        alert("‚ö†Ô∏è Ch∆∞a c√≥ d·ªØ li·ªáu ƒë·ªÉ t·∫£i xu·ªëng!");
        return;
      }

      // Chuy·ªÉn ƒë·ªïi d·ªØ li·ªáu th√†nh d·∫°ng ph√π h·ª£p cho Excel
      const exportData = lastData.map(item => ({
        "M√£ ƒë∆°n": item.orderId || "",
        "Ng∆∞·ªùi nh·∫≠n": item.receiverName || "",
        "ƒê·ªãa ch·ªâ": item.receiverAddress || "",
        "M√£ ƒëo·∫°n": item.terminalDispatchCode || ""
      }));

      const ws = XLSX.utils.json_to_sheet(exportData);
      const wb = XLSX.utils.book_new();
      XLSX.utils.book_append_sheet(wb, ws, "Danh s√°ch ƒë∆°n h√†ng");

      XLSX.writeFile(wb, "dia_chi_don_hang.xlsx");
    }
  </script>
</body>
</html>
